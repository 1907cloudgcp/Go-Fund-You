steps:
# Run tests using maven
- name: 'maven:3.6.1-jdk-8-slim'
  entrypoint: 'mvn'
  args: ['install']
  env:
  - 'DATABASE_NAME=postgres'
  - 'JDBC_SCHEMA=gofundyou'
  - 'JDBC_URL=34.66.62.174'
  - 'JDBC_USERNAME=postgres'
  - 'JDBC_PASSWORD=poiuytre'
# Build and push image
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/go-fund-you:latest','--build-arg', 'DATABASE_NAME=$$DATABASE_NAME', '--build-arg', 'JDBC_SCHEMA=$$JDBC_SCHEMA', '--build-arg', 'JDBC_URL=$$JDBC_URL', '--build-arg', 'JDBC_USERNAME=$$JDBC_USERNAME', '--build-arg', 'JDBC_PASSWORD=$$JDBC_PASSWORD', '-f', './devops/Dockerfile', '.']
  env:
  - 'DATABASE_NAME=postgres'
  - 'JDBC_SCHEMA=gofundyou'
  - 'JDBC_URL=34.66.62.174'
  - 'JDBC_USERNAME=postgres'
  - 'JDBC_PASSWORD=poiuytre'
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'gcr.io/$PROJECT_ID/go-fund-you:latest']
# Deploy into App Engine
- name: "gcr.io/cloud-builders/gcloud"
  args: ['app', 'deploy', './devops/app.yaml', '--image-url=gcr.io/$PROJECT_ID/go-fund-you:latest']
timeout: "1600s"
